# 微信小程序网络请求错误解决方案

## 问题描述
微信小程序在请求`http://localhost:3000`时出现**合法域名校验错误**，即使已经在`project.config.json`中配置了相关域名。

## 当前解决方案：模拟数据模式（推荐）

我们已在`utils/request.js`中实现了完整的模拟数据功能，这是目前最简单有效的解决方案，可以完全避免网络请求和域名校验问题。

### 实现细节

1. **路径匹配修正**
   - 修复了模拟数据路径，从`/api/users/login`改为`/users/login`，与实际调用路径完全匹配
   - 同样修复了`/users/profile`路径

2. **数据结构修正**
   - 调整了登录接口返回数据的结构，将`userInfo`键改为`user`，确保与前端代码处理逻辑一致

3. **动态用户ID支持**
   - 添加了对`/users/:userId`格式URL的支持，可以为任意用户ID返回动态生成的模拟数据
   - 不同用户ID会返回不同的模拟数据，用于查看他人资料功能

4. **自动启用**
   - 模拟数据功能默认已启用（`useMockData = true`），无需额外配置
   - 请求时会在控制台打印`使用模拟数据响应:`或`使用动态用户模拟数据:`信息

## 验证方法

1. 在微信开发者工具中重新编译小程序
2. 点击登录按钮，应该可以成功登录并跳转到首页
3. 查看控制台输出，确认请求是否使用了模拟数据
4. 测试个人资料页面，应该能正确显示用户信息

## 其他解决方案（备用）

### 1. 跳过域名校验（仅开发环境）

在微信开发者工具中：
1. 点击右上角的"详情"按钮
2. 选择"本地设置"选项卡
3. 勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"
4. 重新编译小程序

### 2. 配置 project.config.json

已确认`project.config.json`中已正确配置了`requestDomain`：
```json
"requestDomain": [
  "http://localhost:3000",
  "https://localhost:3000"
]
```
配置后需要重启微信开发者工具并重新编译项目。

### 3. 使用代理

可以通过修改`utils/request.js`实现代理功能，将请求转发到已配置的合法域名。

## 切换到真实环境

当需要连接真实后端服务器时，只需修改`utils/request.js`中的`useMockData`变量：

```javascript
const useMockData = false; // 设置为 false 表示使用真实网络请求
```

## 注意事项

1. 模拟数据模式下，所有请求都会返回预设的模拟数据，不会发送真实网络请求
2. 当前的模拟数据支持以下接口：
   - `/users/login` - 登录接口
   - `/users/profile` - 获取当前用户资料
   - `/users/:userId` - 获取指定用户资料
3. 如需添加更多接口的模拟数据，可以在`utils/request.js`的`mockData`对象中扩展

## 常见问题解答

**Q: 为什么即使配置了合法域名还是报错？**
**A:** 微信开发者工具有时需要重启才能正确加载配置变更，另外使用模拟数据是最可靠的开发方案。

**Q: 如何查看当前是否使用了模拟数据？**
**A:** 查看控制台输出，如果包含"使用模拟数据响应:"或"使用动态用户模拟数据:"信息，则表示正在使用模拟数据。

**Q: 模拟数据和真实接口返回的数据结构是否一致？**
**A:** 是的，我们已经确保模拟数据的结构与前端代码的处理逻辑完全匹配。