<!-- pages/chat/chat.wxml -->
<view class="container">
  <!-- å¼•å…¥AIèŠå¤©åŠ©æ‰‹ç»„ä»¶ -->
  <ai-chat-assistant 
    id="ai-chat-assistant"
    chat-history="{{messages}}"
    target-user-info="{{userInfo}}"
    bind:replyselect="onReplySelect"
  />

  <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
  <scroll-view 
    id="message-container"
    class="message-container"
    scroll-y="true"
    scroll-top="{{scrollTop}}"
    bindscroll="onScroll"
  >
    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{isLoading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list">
      <!-- å¯¹æ–¹æ¶ˆæ¯ -->
      <view 
        class="message-item other-message" 
        wx:for="{{messages}}" 
        wx:key="_id"
        wx:if="{{item.senderId !== app.globalData.userInfo.id}}"
      >
        <image 
          class="avatar" 
          src="{{userInfo.avatar || 'https://picsum.photos/100/100'}}" 
          mode="aspectFill"
        ></image>
        <view class="message-content">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view class="message-bubble" wx:if="{{item.type === 'text'}}">
            <text class="message-text">{{item.content}}</text>
          </view>
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble" wx:elif="{{item.type === 'image'}}">
            <image 
              class="message-image" 
              src="{{item.content}}" 
              mode="aspectFit"
              bindtap="previewImage"
              data-src="{{item.content}}"
            ></image>
          </view>
          <!-- æ—¶é—´ -->
          <text class="message-time">{{formatTime(item.timestamp)}}</text>
        </view>
      </view>
      
      <!-- æˆ‘çš„æ¶ˆæ¯ -->
      <view 
        class="message-item my-message" 
        wx:for="{{messages}}" 
        wx:key="_id"
        wx:if="{{item.senderId === app.globalData.userInfo.id}}"
      >
        <view class="message-content">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view class="message-bubble" wx:if="{{item.type === 'text'}}">
            <text class="message-text">{{item.content}}</text>
          </view>
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble" wx:elif="{{item.type === 'image'}}">
            <image 
              class="message-image" 
              src="{{item.content}}" 
              mode="aspectFit"
              bindtap="previewImage"
              data-src="{{item.content}}"
            ></image>
          </view>
          <!-- æ—¶é—´ -->
          <text class="message-time">{{formatTime(item.timestamp)}}</text>
        </view>
        <image 
          class="avatar" 
          src="{{app.globalData.userInfo.avatar || 'https://picsum.photos/100/100'}}" 
          mode="aspectFill"
        ></image>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!isLoading && messages.length === 0}}">
      <text>å¼€å§‹ä½ ä»¬çš„èŠå¤©å§</text>
    </view>
  </scroll-view>
  
  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <!-- AIåŠ©æ‰‹æŒ‰é’® -->
    <view class="input-tool" bindtap="toggleAIAssistant">
      <image src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007aff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E" mode="aspectFit" class="tool-icon" />
    </view>
    
    <!-- è¡¨æƒ…æŒ‰é’® -->
    <view class="input-tool" bindtap="showEmojiPanel">
      <text class="tool-icon">ğŸ˜Š</text>
    </view>
    
    <!-- å›¾ç‰‡æŒ‰é’® -->
    <view class="input-tool" bindtap="showImagePicker">
      <text class="tool-icon">ğŸ“·</text>
    </view>
    
    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <input 
        class="input" 
        value="{{inputValue}}" 
        bindinput="onInput"
        placeholder="è¾“å…¥æ¶ˆæ¯..."
        placeholder-class="placeholder"
        confirm-type="send"
        bindconfirm="sendMessage"
      />
    </view>
    
    <!-- å‘é€æŒ‰é’® -->
    <button 
      class="send-btn" 
      type="primary" 
      size="mini" 
      disabled="{{!inputValue.trim() || isSending}}"
      bindtap="sendMessage"
    >
      å‘é€
    </button>
  </view>
  
  <!-- è¡¨æƒ…é¢æ¿ -->
  <view class="emoji-panel" wx:if="{{showEmoji}}">
    <view class="emoji-list">
      <view class="emoji-item" wx:for="{{['ğŸ˜Š', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™']}}" wx:key="index" bindtap="selectEmoji" data-emoji="{{item}}">
        <text>{{item}}</text>
      </view>
    </view>
  </view>
</view>